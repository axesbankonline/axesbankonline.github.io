<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ticket Debug System</title>
  <style>
    body { font-family: Segoe UI, Arial; background: #222; color: #fff; margin: 0; min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;}
    .box { background:#2d2d2d;border-radius:14px;box-shadow:0 8px 30px #1114; padding:38px 34px; margin:28px 0;}
    .btn {background:#7289da;color:#fff;border:none;border-radius:7px;padding:13px 36px;font-size:1.11em;margin-top:11px;cursor:pointer;}
    h2 {color:#43b581;}
    label {margin-top:15px;display:block;}
    input {border-radius:5px; border:none; padding:8px; margin-top:8px; width:170px;}
    .msg {margin-top:13px;font-size:1em;padding:4px;}
    .info { color:#43b581;}
    .error { color:#ff5c5c;}
    .debug {background:#111; color:#ddd; font-size:.95em; margin-top:20px; padding:7px 13px;}
  </style>
</head>
<body>
  <div class="box" id="createBox">
    <h2>Create Transaction Ticket</h2>
    <label>Offer Amount:</label>
    <input type="number" id="offerAmount" min="1" placeholder="Coins to offer"/>
    <button class="btn" onclick="createTicket()">Create Ticket</button>
    <div class="msg" id="createMsg"></div>
    <div class="debug" id="createDebug"></div>
  </div>
  <div class="box" id="enterBox">
    <h2>Enter Ticket Number</h2>
    <label>Ticket Number:</label>
    <input type="text" id="ticketNumber" placeholder="Paste code here"/>
    <button class="btn" onclick="lookupTicket()">Lookup Ticket</button>
    <div class="msg" id="lookupMsg"></div>
    <div class="debug" id="lookupDebug"></div>
  </div>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-auth-compat.js"></script>
  <script>
    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBjkyVHbax09W9viyKmBH-MXQXqyfizJws",
      authDomain: "bankdata-fe769.firebaseapp.com",
      databaseURL: "https://bankdata-fe769-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "bankdata-fe769",
      storageBucket: "bankdata-fe769.appspot.com",
      messagingSenderId: "967507656753",
      appId: "1:967507656753:web:562c1383dca78d56471510"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let lastTicketData = null;
    let lastTicketId = null;
    let lastTicketSenderUid = null;

    function showMsg(id, msg, isError) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.className = 'msg ' + (isError ? 'error' : 'info');
    }

    function showDebug(id, msg) {
      document.getElementById(id).innerText = msg;
    }

    // CREATE TICKET
    function createTicket() {
      showMsg("createMsg", "", false);
      showDebug("createDebug", "");
      const amount = parseInt(document.getElementById("offerAmount").value, 10);
      const user = auth.currentUser;
      if (!user) {
        showMsg("createMsg", "You must be signed in!", true);
        return;
      }
      if (!amount || amount < 1) {
        showMsg("createMsg", "Enter a valid amount.", true);
        return;
      }
      // Show your UID and coins
      db.ref("users/"+user.uid+"/coins").get().then(snap=>{
        showDebug("createDebug","Your UID: "+user.uid+"\nYour coins: "+(snap.exists()?snap.val():0));
      });

      const ticketId = Date.now().toString(36) + Math.floor(Math.random() * 10000).toString(36);
      db.ref("users/" + user.uid + "/name").get().then(snap => {
        const name = snap.exists() ? snap.val() : (user.displayName || user.email || "User");
        db.ref("tickets/" + ticketId).set({
          senderUid: user.uid,
          senderName: name,
          amount: amount,
          status: "pending",
          createdAt: Date.now()
        }).then(() => {
          showMsg("createMsg", "âœ… Ticket created!\nTicket Number:\n" + ticketId, false);
          document.getElementById("offerAmount").value = "";
        }).catch(() => {
          showMsg("createMsg", "Error creating ticket.", true);
        });
      });
    }

    // LOOKUP TICKET
    function lookupTicket() {
      showMsg("lookupMsg", "", false);
      showDebug("lookupDebug","");
      document.getElementById("acceptBtn")?.remove();
      const ticketId = document.getElementById("ticketNumber").value.trim();
      if (!ticketId) {
        showMsg("lookupMsg", "Enter a ticket number.", true);
        return;
      }
      db.ref("tickets/" + ticketId).get().then(snap => {
        if (!snap.exists()) {
          showMsg("lookupMsg", "No ticket found for this number.", true);
          return;
        }
        const data = snap.val();
        lastTicketData = data;
        lastTicketId = ticketId;
        lastTicketSenderUid = data.senderUid;
        showDebug("lookupDebug",`Your UID: ${auth.currentUser?.uid || "(none)"}\nSender UID: ${data.senderUid}\nSender coins: loading...`);
        // Load sender coins
        db.ref("users/"+data.senderUid+"/coins").get().then(csnap=>{
          document.getElementById("lookupDebug").innerText += `\nSender coins: ${(csnap.exists()?csnap.val():0)}`;
        });
        if (data.status !== "pending") {
          showMsg("lookupMsg", "This ticket has already been claimed or is inactive.", true);
          return;
        }
        showMsg("lookupMsg", `ðŸŽŸï¸ ${data.senderName} is offering you ${data.amount} coins.`);
        const user = auth.currentUser;
        if (user && user.uid !== data.senderUid) {
          const btn = document.createElement("button");
          btn.textContent = "Accept Offer";
          btn.className = "btn";
          btn.id = "acceptBtn";
          btn.onclick = acceptOffer;
          document.getElementById("lookupMsg").appendChild(document.createElement("br"));
          document.getElementById("lookupMsg").appendChild(btn);
        } else if (user && user.uid === data.senderUid) {
          showMsg("lookupMsg", "You cannot accept your own ticket.", true);
        }
      }).catch(() => {
        showMsg("lookupMsg", "Error looking up ticket.", true);
      });
    }

    // ACCEPT OFFER (deduct coins only at accept)
    function acceptOffer() {
      const user = auth.currentUser;
      showDebug("lookupDebug", "Your UID: " + user.uid + "\nSender UID: " + lastTicketSenderUid);
      if (!user) {
        showMsg("lookupMsg", "You must be signed in to accept.", true);
        return;
      }
      const ticketId = lastTicketId;
      if (!ticketId || !lastTicketData) {
        showMsg("lookupMsg", "Invalid ticket.", true);
        return;
      }
      const amount = lastTicketData.amount;
      const senderUid = lastTicketData.senderUid;
      if (user.uid === senderUid) {
        showMsg("lookupMsg", "You cannot accept your own ticket.", true);
        return;
      }
      showMsg("lookupMsg", "Processing...", false);
      const ticketRef = db.ref("tickets/" + ticketId);
      // Show sender coins debug BEFORE trying transaction
      db.ref("users/"+senderUid+"/coins").get().then(csnap=>{
        showDebug("lookupDebug",`Your UID: ${user.uid}\nSender UID: ${senderUid}\nSender coins BEFORE: ${(csnap.exists()?csnap.val():0)}`);
      });
      ticketRef.get().then(ticketSnap => {
        if (!ticketSnap.exists()) {
          showMsg("lookupMsg", "Ticket no longer exists.", true);
          return;
        }
        const ticket = ticketSnap.val();
        if (ticket.status !== "pending") {
          showMsg("lookupMsg", "This ticket is no longer available.", true);
          return;
        }
        const senderCoinsRef = db.ref("users/" + senderUid + "/coins");
        senderCoinsRef.transaction(curr => {
          const current = (curr !== null && curr !== undefined) ? curr : 0;
          if (current < amount) return; // abort
          return current - amount;
        }, (err, committed, senderSnap) => {
          showDebug("lookupDebug",`Your UID: ${user.uid}\nSender UID: ${senderUid}\nSender coins AFTER: ${(senderSnap.exists()?senderSnap.val():0)}`);
          if (err) {
            showMsg("lookupMsg", "Transaction error.", true);
            return;
          }
          if (!committed) {
            showMsg("lookupMsg", "Sender does not have enough coins.", true);
            return;
          }
          // Credit recipient and remove ticket
          const receiverCoinsRef = db.ref("users/" + user.uid + "/coins");
          receiverCoinsRef.transaction(rcurr => (rcurr || 0) + amount, (rErr, rCommitted, rSnap) => {
            if (rErr || !rCommitted) {
              showMsg("lookupMsg", "Error crediting your account.", true);
              // Optionally refund in case of error:
              senderCoinsRef.transaction(s => (s || 0) + amount);
              return;
            }
            ticketRef.remove().then(() => {
              showMsg("lookupMsg", `âœ… Offer accepted! ${amount} coins added to your balance.`, false);
              document.getElementById("acceptBtn")?.remove();
              lastTicketId = null;
              lastTicketData = null;
              showDebug("lookupDebug","");
            }).catch(() => {
              showMsg("lookupMsg", "Accepted but failed to delete ticket. Contact support.", true);
            });
          });
        });
      }).catch(() => {
        showMsg("lookupMsg", "Error reading ticket. Try again.", true);
      });
    }

    // AUTH/INITIALIZATION
    auth.onAuthStateChanged(user => {
      if (!user) {
        auth.signInAnonymously();
      } else {
        // Ensure coins node exists
        const userCoinsRef = db.ref("users/" + user.uid + "/coins");
        userCoinsRef.once("value").then(snap => {
          if (!snap.exists()) {
            userCoinsRef.set(0);
          }
        });
        // Ensure name node exists
        db.ref("users/" + user.uid + "/name").once("value").then(snap => {
          if (!snap.exists()) {
            db.ref("users/" + user.uid + "/name").set("Anonymous User");
          }
        });
      }
    });
  </script>
</body>
</html>

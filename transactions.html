<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transaction Ticket System</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial;
      background: #222;
      color: #fff;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .box {
      background: #2d2d2d;
      border-radius: 14px;
      box-shadow: 0 8px 30px #1114;
      padding: 38px 34px;
      margin: 28px 0;
    }
    .btn {
      background: #7289da;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 13px 36px;
      font-size: 1.11em;
      margin-top: 11px;
      cursor: pointer;
    }
    h2 {
      color: #43b581;
    }
    label {
      margin-top: 15px;
      display: block;
    }
    input {
      border-radius: 5px;
      border: none;
      padding: 8px;
      margin-top: 8px;
      width: 170px;
    }
    .msg {
      margin-top: 13px;
      font-size: 1em;
      padding: 4px;
    }
    .info {
      color: #43b581;
    }
    .error {
      color: #ff5c5c;
    }
  </style>
</head>
<body>
  <div class="box" id="createBox">
    <h2>Create Transaction Ticket</h2>
    <label>Offer Amount:</label>
    <input type="number" id="offerAmount" min="1" placeholder="Coins to offer"/>
    <button class="btn" onclick="createTicket()">Create Ticket</button>
    <div class="msg" id="createMsg"></div>
  </div>
  <div class="box" id="enterBox">
    <h2>Enter Ticket Number</h2>
    <label>Ticket Number:</label>
    <input type="text" id="ticketNumber" placeholder="Paste code here"/>
    <button class="btn" onclick="lookupTicket()">Lookup Ticket</button>
    <div class="msg" id="lookupMsg"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-auth-compat.js"></script>
  <script>
    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBjkyVHbax09W9viyKmBH-MXQXqyfizJws",
      authDomain: "bankdata-fe769.firebaseapp.com",
      databaseURL: "https://bankdata-fe769-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "bankdata-fe769",
      storageBucket: "bankdata-fe769.appspot.com",
      messagingSenderId: "967507656753",
      appId: "1:967507656753:web:562c1383dca78d56471510"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    function showMsg(id, msg, isError) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.className = 'msg ' + (isError ? 'error' : 'info');
    }

    // CREATE TICKET
    function createTicket() {
      showMsg("createMsg", "", false);
      const amount = parseInt(document.getElementById("offerAmount").value, 10);
      const user = auth.currentUser;
      if (!user) {
        showMsg("createMsg", "You must be signed in!", true);
        return;
      }
      if (!amount || amount < 1) {
        showMsg("createMsg", "Enter a valid amount.", true);
        return;
      }
      const ticketId = Date.now().toString(36) + Math.floor(Math.random() * 10000).toString(36);

      db.ref("users/" + user.uid + "/name").get().then(snap => {
        const name = snap.exists() ? snap.val() : (user.displayName || user.email || "User");

        db.ref("tickets/" + ticketId).set({
          senderUid: user.uid,
          senderName: name,
          amount: amount,
          status: "pending"
        }).then(() => {
          showMsg("createMsg", "✅ Ticket created!\nTicket Number:\n" + ticketId, false);
          document.getElementById("offerAmount").value = "";
        }).catch(() => {
          showMsg("createMsg", "Error creating ticket.", true);
        });
      });
    }

    let lastTicketData = null;
    let lastTicketId = null;

    // LOOKUP TICKET
    function lookupTicket() {
      showMsg("lookupMsg", "", false);
      document.getElementById("acceptBtn")?.remove();
      const ticketId = document.getElementById("ticketNumber").value.trim();
      if (!ticketId) {
        showMsg("lookupMsg", "Enter a ticket number.", true);
        return;
      }
      db.ref("tickets/" + ticketId).get().then(snap => {
        if (!snap.exists()) {
          showMsg("lookupMsg", "No ticket found for this number.", true);
          return;
        }
        const data = snap.val();
        lastTicketData = data;
        lastTicketId = ticketId;
        if (data.status !== "pending") {
          showMsg("lookupMsg", "This ticket has already been claimed or is inactive.", true);
          return;
        }
        showMsg("lookupMsg", `🎟️ ${data.senderName} is offering you ${data.amount} coins.`);
        const btn = document.createElement("button");
        btn.textContent = "Accept Offer";
        btn.className = "btn";
        btn.id = "acceptBtn";
        btn.onclick = acceptOffer;
        document.getElementById("lookupMsg").appendChild(document.createElement("br"));
        document.getElementById("lookupMsg").appendChild(btn);
      }).catch(() => {
        showMsg("lookupMsg", "Error looking up ticket.", true);
      });
    }

    // ACCEPT OFFER — FIXED
    function acceptOffer() {
      const user = auth.currentUser;
      if (!user) {
        showMsg("lookupMsg", "You must be signed in to accept.", true);
        return;
      }
      const ticketId = lastTicketId;
      if (!ticketId || !lastTicketData) {
        showMsg("lookupMsg", "Invalid ticket.", true);
        return;
      }

      const amount = lastTicketData.amount;
      const senderUid = lastTicketData.senderUid;

      if (user.uid === senderUid) {
        showMsg("lookupMsg", "You cannot accept your own ticket.", true);
        return;
      }

      showMsg("lookupMsg", "Processing...", false);

      const ticketRef = db.ref("tickets/" + ticketId);

      ticketRef.get().then(ticketSnap => {
        if (!ticketSnap.exists()) {
          showMsg("lookupMsg", "Ticket no longer exists.", true);
          return;
        }
        const ticket = ticketSnap.val();
        if (ticket.status !== "pending") {
          showMsg("lookupMsg", "This ticket is no longer available.", true);
          return;
        }

        const senderCoinsRef = db.ref("users/" + senderUid + "/coins");

        senderCoinsRef.transaction(curr => {
          const current = (curr !== null && curr !== undefined) ? curr : 0;
          if (current < amount) return; // abort
          return current - amount;
        }, (err, committed, senderSnap) => {
          if (err) {
            console.error("Transaction error:", err);
            showMsg("lookupMsg", "Error while checking sender's balance.", true);
            return;
          }
          if (!committed) {
            showMsg("lookupMsg", "Sender does not have enough coins.", true);
            return;
          }

          const receiverCoinsRef = db.ref("users/" + user.uid + "/coins");

          receiverCoinsRef.transaction(rcurr => (rcurr || 0) + amount, (rErr, rCommitted, rSnap) => {
            if (rErr || !rCommitted) {
              showMsg("lookupMsg", "Error crediting your account. Refunding sender...", true);
              senderCoinsRef.transaction(s => (s || 0) + amount);
              return;
            }

            ticketRef.update({
              status: "accepted",
              acceptedBy: user.uid,
              acceptedAt: Date.now()
            }).then(() => {
              showMsg("lookupMsg", `✅ Offer accepted! ${amount} coins added to your balance.`, false);
              document.getElementById("acceptBtn")?.remove();
              lastTicketId = null;
              lastTicketData = null;
            }).catch(() => {
              showMsg("lookupMsg", "Accepted but failed to update ticket status. Contact support.", true);
            });
          });
        });
      }).catch(() => {
        showMsg("lookupMsg", "Error reading ticket. Try again.", true);
      });
    }

    // AUTH — ensures coin balance is initialized
    auth.onAuthStateChanged(user => {
      if (!user) {
        auth.signInAnonymously();
      } else {
        // Ensure coins node exists
        const userCoinsRef = db.ref("users/" + user.uid + "/coins");
        userCoinsRef.once("value").then(snap => {
          if (!snap.exists()) {
            userCoinsRef.set(0);
          }
        });

        // Ensure name node exists (optional)
        db.ref("users/" + user.uid + "/name").once("value").then(snap => {
          if (!snap.exists()) {
            db.ref("users/" + user.uid + "/name").set("Anonymous User");
          }
        });
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spin The Wheel â€” Earn Coins</title>
  <style>
    body { font-family: Segoe UI, Arial; background: #222; color: #fff; min-height:100vh;
      display:flex; flex-direction:column; align-items:center;}
    .box { background:#2d2d2d; border-radius:14px; box-shadow:0 8px 30px #1114;
      padding:38px 34px; margin:32px 0 20px 0; width:350px; max-width:96vw; }
    h2 { color:#6ce154; margin:16px 0 8px 0;}
    .info-row { width:100%; background:#191d22; border-radius:8px; padding:10px 18px;
      font-family:monospace; margin:10px 0 18px 0; }
    input, .btn { border-radius:6px; border:none; padding:8px; font-size:1.09em;}
    .btn { background:#7289da; color:#fff; font-weight:600; margin-top:10px; cursor:pointer; }
    .row { display:flex; gap:8px; margin-top:10px;}
    .msg { margin-top:10px; font-size:1em; min-height:1em;}
    .info { color:#43b581; }
    .error { color:#ff5c5c; }
    #wheelMsg { margin-top:18px; margin-bottom:5px;}
  </style>
</head>
<body>
  <div class="box" id="mainBox" style="display:none;">
    <h2>Earn: Spin the Wheel</h2>
    <div class="info-row" id="userInfo"></div>
    <div id="spinInfo"></div>
    <div class="row">
      <button class="btn" onclick="spinTheWheel()" id="spinBtn">Spin (<span id="spinCost">...</span> coins)</button>
      <button class="btn" onclick="showAdSpin()" id="adSpinBtn" style="background:#43b581;">Watch Ad for Free Spin</button>
    </div>
    <div class="msg" id="spinMsg"></div>
    <div class="msg" id="wheelMsg"></div>
  </div>

  <!-- Simulated Ad overlay (hide in real prod, replace with actual ad logic) -->
  <div class="box" id="adOverlay" style="display:none;position:fixed;top:30vh;left:0;right:0;margin:auto;">
    <h2>Watch Ad</h2>
    <div class="msg">[Ad playing simulation...]</div>
    <button class="btn" onclick="finishAd()">I've finished watching the ad</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjkyVHbax09W9viyKmBH-MXQXqyfizJws",
      authDomain: "bankdata-fe769.firebaseapp.com",
      databaseURL: "https://bankdata-fe769-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "bankdata-fe769",
      storageBucket: "bankdata-fe769.appspot.com",
      messagingSenderId: "967507656753",
      appId: "1:967507656753:web:562c1383dca78d56471510"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUser = null, userData = {};
    function showMsg(id, msg, isError=false) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.className = 'msg ' + (isError ? 'error' : 'info');
    }
    function updateSpinCost(cost) {
      document.getElementById("spinCost").textContent = cost;
    }

    function getNextSpinCost(spins) {
      return Math.floor(20 * Math.pow(1.05, spins || 0));
    }

    // Auth & user info
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById("mainBox").style.display = "";
        db.ref("users/"+user.uid).on("value", snap => {
          userData = snap.val() || {};
          let coins = typeof userData.coins === "number" ? userData.coins : parseInt(userData.coins||0,10);
          if (!isFinite(coins)) coins = 0;
          let spins = parseInt(userData.spins) || 0;
          document.getElementById("userInfo").textContent =
            `ID: ${user.uid}\nCoins: ${coins}\nSpins so far: ${spins}`;
          const cost = getNextSpinCost(spins);
          updateSpinCost(cost);
        });
      } else {
        auth.signInAnonymously();
      }
    });

    // Prize logic
    function spinTheWheel(freeSpin=false) {
      showMsg("spinMsg", "");
      showMsg("wheelMsg", "");
      if (!currentUser) return;
      const coins = parseInt(userData.coins||"0",10);
      let spins = parseInt(userData.spins)||0;
      const spinCost = getNextSpinCost(spins);
      if (!freeSpin && coins < spinCost) return showMsg("spinMsg", "Not enough coins!", true);

      // Prize roll
      const roll = Math.random() * 100;
      let crate, crateText, prize = 0;
      if      (roll <  1) { crate="hacker";    crateText="Hacker Ticket";    prize = rand(100000,1000000);}
      else if (roll <  3) { crate="legendary"; crateText="Legendary Ticket"; prize = rand(1000,10000);}
      else if (roll <  8) { crate="epic";      crateText="Epic Ticket";      prize = rand(500,1000);}
      else if (roll < 20) { crate="rare";      crateText="Rare Ticket";      prize = rand(100,500);}
      else if (roll < 50) { crate="mediocre";  crateText="Mediocre Ticket";  prize = rand(20,50);}
      else                { crate="common";    crateText="Common Ticket";    prize = rand(10,30);}

      // Prepare new values
      let updates = {};
      if (!freeSpin) {
        updates["/users/"+currentUser.uid+"/coins"] = coins - spinCost + prize;
        updates["/users/"+currentUser.uid+"/spins"] = spins + 1;
      } else {
        updates["/users/"+currentUser.uid+"/coins"] = coins + prize;
      }
      db.ref().update(updates).then(()=>{
        showMsg("wheelMsg", `ðŸŽ‰ You won a ${crateText} and got ${prize} coins!`, false);
        document.getElementById("spinBtn").disabled = false;
        document.getElementById("adSpinBtn").disabled = false;
      });
      document.getElementById("spinBtn").disabled = true;
      document.getElementById("adSpinBtn").disabled = true;
      setTimeout(() => {
        document.getElementById("spinBtn").disabled = false;
        document.getElementById("adSpinBtn").disabled = false;
      }, 1800);
    }
    function rand(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }

    // Ad / free spin logic (youâ€™ll use a real ad provider in prod)
    function showAdSpin() {
      document.getElementById("adOverlay").style.display = "";
      showMsg("spinMsg", "Watch the ad to earn your spin!", false);
    }
    function finishAd() {
      document.getElementById("adOverlay").style.display = "none";
      spinTheWheel(true);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Send Money - Axes Bank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #1a1a1a; color: #fff; font-family: 'Segoe UI',system-ui,sans-serif; margin: 0; min-height: 100vh; }
    .container { max-width: 370px; margin: 120px auto 0; background: #2d2d2d; border-radius: 18px; box-shadow: 0 8px 32px rgba(0,0,0,0.19); padding: 34px 24px 24px 24px; display: flex; flex-direction: column; align-items: center; }
    h2 { color: #7289da; margin-bottom: 12px;}
    label { color: #43b581; font-weight: 600; display: block; }
    input[type="text"], input[type="number"] { width: 100%; max-width: 240px; padding: 10px; border-radius: 7px; border: none; margin: 7px 0 15px 0; font-size: 1rem; background: #181a20; color: #fff; box-shadow: 0 1px 5px #2223;}
    button { background: #7289da; color: #fff; border: none; border-radius: 8px; padding: 12px 30px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 14px; transition: background 0.16s; }
    .status-msg { margin-top: 16px; font-size: 1rem; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Send Money</h2>
    <form id="transForm" autocomplete="off">
      <label for="toUid">Recipient UID</label>
      <input type="text" id="toUid" required autocomplete="off" placeholder="Paste UID here" />
      <label for="amount">Amount</label>
      <input type="number" id="amount" min="1" required placeholder="How much to send?"/>
      <button type="submit" id="sendBtn">Send</button>
      <div class="status-msg" id="statusMsg"></div>
    </form>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getDatabase, ref, get, runTransaction } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBjkyVHbax09W9viyKmBH-MXQXqyfizJws",
      authDomain: "bankdata-fe769.firebaseapp.com",
      databaseURL: "https://bankdata-fe769-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "bankdata-fe769",
      storageBucket: "bankdata-fe769.appspot.com",
      messagingSenderId: "967507656753",
      appId: "1:967507656753:web:562c1383dca78d56471510"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth();

    let myUid = null;

    function showStatus(msg, color="#43b581") {
      const msgDiv = document.getElementById('statusMsg');
      msgDiv.textContent = msg;
      msgDiv.style.color = color;
    }

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        myUid = user.uid;
      }
    });

    document.getElementById('transForm').addEventListener('submit', function(e){
      e.preventDefault();
      showStatus("");
      const toUid = document.getElementById('toUid').value.trim();
      const amount = parseInt(document.getElementById('amount').value, 10);

      if (!myUid) {
        showStatus("Still loading, please wait...", "#ff4c6c"); return;
      }
      if (!toUid || toUid === myUid) {
        showStatus("Invalid recipient.", "#ff4c6c"); return;
      }
      if (isNaN(amount) || amount < 1) {
        showStatus("Enter a valid amount.", "#ff4c6c"); return;
      }

      // Only modify own coins atomically (because can't write recipient's coins)
      const fromRef = ref(database, `users/${myUid}/coins`);
      get(ref(database, `users/${myUid}`)).then(snapFrom => {
        if (!snapFrom.exists() || (snapFrom.val().coins||0) < amount) {
          showStatus("Insufficient balance.", "#ff4c6c"); return;
        }
        runTransaction(fromRef, curr => {
          if ((curr||0) < amount) return;
          return (curr||0) - amount;
        }).then(res1 => {
          if (!res1.committed) {
            showStatus("Insufficient balance.", "#ff4c6c"); return;
          }
          // Success subtract; now add directly to recipient via "update" REST API, admin, or backend server (not allowed with current rules from client)
          showStatus(`Sent ${amount} coins to ${toUid}! (Recipient's balance may not update due to rules)`, "#43b581");
          document.getElementById('transForm').reset();
        }).catch(()=>showStatus("Transaction failed. Try again.", "#ff4c6c"));
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Send Money - Axes Bank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #1a1a1a; color: #fff; font-family: 'Segoe UI',system-ui,sans-serif; margin: 0; min-height: 100vh; }
    .container { max-width: 370px; margin: 120px auto 0; background: #2d2d2d; border-radius: 18px; box-shadow: 0 8px 32px rgba(0,0,0,0.19); padding: 34px 24px 24px 24px; display: flex; flex-direction: column; align-items: center; }
    h2 { color: #7289da; margin-bottom: 12px;}
    label { color: #43b581; font-weight: 600; display: block; }
    input[type="text"], input[type="number"] { width: 100%; max-width: 240px; padding: 10px; border-radius: 7px; border: none; margin: 7px 0 15px 0; font-size: 1rem; background: #181a20; color: #fff; box-shadow: 0 1px 5px #2223;}
    button { background: #7289da; color: #fff; border: none; border-radius: 8px; padding: 12px 30px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 14px; transition: background 0.16s; }
    button:disabled { background: #444a; color: #fff; cursor: not-allowed; }
    .status-msg { margin-top: 16px; font-size: 1rem; text-align: center; }
    .recipient-box { color: #43b581; font-weight: 700; margin-top: -10px; margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Send Money</h2>
    <form id="transForm" autocomplete="off">
      <label for="toUid">Recipient UID</label>
      <input type="text" id="toUid" required autocomplete="off" placeholder="Paste UID here" />
      <div id="recipientBox" class="recipient-box"></div>
      <label for="amount">Amount</label>
      <input type="number" id="amount" min="1" required placeholder="How much to send?"/>
      <button type="submit" id="sendBtn" disabled>Send</button>
      <div class="status-msg" id="statusMsg"></div>
    </form>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getDatabase, ref, get, runTransaction } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBjkyVHbax09W9viyKmBH-MXQXqyfizJws",
      authDomain: "bankdata-fe769.firebaseapp.com",
      databaseURL: "https://bankdata-fe769-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "bankdata-fe769",
      storageBucket: "bankdata-fe769.appspot.com",
      messagingSenderId: "967507656753",
      appId: "1:967507656753:web:562c1383dca78d56471510"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth();

    let myUid = null;
    let ready = false;

    function updateRecipientBox(uid) {
      const box = document.getElementById('recipientBox');
      const sendBtn = document.getElementById('sendBtn');
      box.textContent = "";
      sendBtn.disabled = true;
      if (!ready || !uid || !myUid) return;
      if (uid === myUid) {
        box.textContent = "You cannot send money to yourself.";
        box.style.color = "#ff4c6c";
        sendBtn.disabled = true;
        return;
      }
      // Strictly check for recipient in users node
      get(ref(database, `users/${uid}`)).then(snapshot => {
        if (snapshot.exists()) {
          const user = snapshot.val();
          box.textContent = "Recipient: " + (user.name || "(No Name)");
          box.style.color = "#43b581";
          sendBtn.disabled = false;
        } else {
          box.textContent = "No user found for this UID.";
          box.style.color = "#ff4c6c";
          sendBtn.disabled = true;
        }
      }).catch((e) => {
        box.textContent = "Error fetching recipient: " + e.message;
        box.style.color = "#ff4c6c";
        sendBtn.disabled = true;
      });
    }

    function showStatus(msg, color="#43b581") {
      document.getElementById('statusMsg').textContent = msg;
      document.getElementById('statusMsg').style.color = color;
    }

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        myUid = user.uid;
        ready = true;
        // If input box already has value, check it
        const toUidInput = document.getElementById('toUid');
        if (toUidInput.value.trim()) updateRecipientBox(toUidInput.value.trim());
      }
    });

    document.getElementById('toUid').addEventListener('input', function() {
      if (ready) updateRecipientBox(this.value.trim());
      document.getElementById('statusMsg').textContent = "";
    });

    document.getElementById('transForm').addEventListener('submit', function(e){
      e.preventDefault();
      showStatus("");
      const toUid = document.getElementById('toUid').value.trim();
      const amount = parseInt(document.getElementById('amount').value, 10);

      if (!ready || !myUid || !toUid || toUid === myUid) {
        showStatus("Invalid recipient.", "#ff4c6c"); return;
      }
      if (isNaN(amount) || amount < 1) {
        showStatus("Enter a valid amount.", "#ff4c6c"); return;
      }
      // Transaction logic checks balance and recipient existence
      const fromRef = ref(database, `users/${myUid}/coins`);
      const toRef = ref(database, `users/${toUid}/coins`);
      Promise.all([
        get(ref(database, `users/${myUid}`)),
        get(ref(database, `users/${toUid}`))
      ]).then(([snapFrom, snapTo]) => {
        if (!snapTo.exists()) {
          showStatus("Recipient not found.", "#ff4c6c"); return;
        }
        if (!snapFrom.exists() || (snapFrom.val().coins||0) < amount) {
          showStatus("Insufficient balance.", "#ff4c6c"); return;
        }
        runTransaction(fromRef, curr => {
          if ((curr||0) < amount) return; // Abort
          return (curr||0) - amount;
        }).then(res1 => {
          if (!res1.committed) {
            showStatus("Insufficient balance.", "#ff4c6c"); return;
          }
          runTransaction(toRef, curr => (curr||0)+amount).then(() => {
            showStatus(`Sent ${amount} coins!`, "#43b581");
            document.getElementById('transForm').reset();
            document.getElementById('recipientBox').textContent = "";
            document.getElementById('sendBtn').disabled = true;
          }).catch(()=>showStatus("Failed to credit recipient.", "#ff4c6c"));
        }).catch(()=>showStatus("Transaction failed. Try again.", "#ff4c6c"));
      });
    });
  </script>
</body>
</html>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";

    const firebaseConfig = { /* Your Firebase Config */ };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Check logged-in user
    get(ref(db, "currentSession/user")).then(snapshot => {
        if (!snapshot.exists()) {
            window.location.href = "index.html";
        } else {
            const loggedInUser = snapshot.val();
            document.getElementById("betButton").addEventListener("click", () => placeBet(loggedInUser));
        }
    });

    function placeBet(userCred) {
        let betAmount = parseInt(document.getElementById("betAmount").value);
        if (isNaN(betAmount) || betAmount <= 0) {
            alert("Enter a valid amount.");
            return;
        }

        const userRef = ref(db, `users/${userCred}`);
        get(userRef).then(snapshot => {
            if (snapshot.exists()) {
                let userData = snapshot.val();
                if (userData.coins < betAmount) {
                    alert("Insufficient balance.");
                    return;
                }

                let outcome = Math.random();
                let newBalance = userData.coins;
                const adminAccountRef = ref(db, "users/4179170033006493");

                if (outcome < 0.6) {
                    newBalance += betAmount * 5; // Win
                    alert(`You won! Your balance is now ${newBalance}`);
                } else if (outcome < 0.9) {
                    newBalance -= betAmount; // Lose
                    alert(`You lost! Your balance is now ${newBalance}`);

                    // Transfer lost money to admin
                    get(adminAccountRef).then(adminSnapshot => {
                        if (adminSnapshot.exists()) {
                            let adminData = adminSnapshot.val();
                            update(adminAccountRef, { coins: adminData.coins + betAmount });
                        }
                    });
                } else {
                    alert(`You broke even. Your balance remains the same.`);
                }

                // Update user balance
                update(userRef, { coins: newBalance });
            }
        });
    }
</script>
